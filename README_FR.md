# WVP-GB28181-PRO 功能研究报告

## FR01-JT1078: JT1078音视频传输协议模块

### 1. JT1078协议背景

**JT1078**是交通运输部制定的**道路运输车辆卫星定位系统车载终端技术要求**中的音视频传输协议，属于**JT/T 808**协议的扩展部分。该协议专门用于车载终端的音视频数据传输。

### 2. 模块架构分析

#### 2.1 目录结构
```
jt1078/
├── annotation/          # 注解定义
│   └── MsgId.java      # 消息ID注解
├── cmd/                # 命令模板
│   └── JT1078Template.java  # JT1078命令模板
├── codec/              # 编解码器
│   ├── decode/         # 解码器
│   ├── encode/         # 编码器
│   └── netty/          # Netty网络处理
├── config/             # 配置类
│   ├── JT1078AutoConfiguration.java  # 自动配置
│   └── JT1078Controller.java         # REST API控制器
├── proc/               # 协议处理
│   ├── entity/         # 实体类
│   ├── factory/        # 工厂类
│   ├── request/        # 请求处理
│   └── response/       # 响应处理
├── session/            # 会话管理
└── util/               # 工具类
```

#### 2.2 核心组件分析

**1. 网络服务层 (TcpServer)**
- 基于Netty框架实现TCP服务器
- 监听端口：21078（可配置）
- 支持JT808协议的消息解析和响应
- 使用0x7e作为消息分隔符

**2. 命令模板层 (JT1078Template)**
提供标准化的JT1078命令接口：
- `startLive()` - 开启实时音视频传输
- `stopLive()` - 关闭实时音视频传输  
- `queryBackTime()` - 查询音视频列表
- `startBackLive()` - 开启视频回放
- `controlBackLive()` - 视频回放控制

**3. 消息处理层**
支持的消息类型：
- **9101**: 实时音视频传输请求
- **9102**: 实时音视频传输停止请求
- **9201**: 音视频回放请求
- **9202**: 音视频回放控制请求
- **9205**: 音视频资源列表请求

### 3. 功能特性分析

#### 3.1 音视频传输功能
```java
// 实时音视频传输参数 (J9101)
- IP地址: 服务器IP
- TCP端口: 音视频数据传输端口
- UDP端口: 音视频数据传输端口  
- 逻辑通道号: 设备通道号
- 数据类型: 0-音视频, 1-视频, 2-双向对讲, 3-监听, 4-中心广播, 5-透传
- 码流类型: 0-主码流, 1-子码流
```

#### 3.2 回放控制功能
```java
// 音视频回放参数 (J9201)
- 逻辑通道号: 设备通道号
- 回放方式: 0-正常回放, 1-快进回放, 2-关键帧快退回放, 3-关键帧播放, 4-单帧上传
- 快进或快退倍数: 回放速度倍数
- 起始时间: 回放开始时间
- 结束时间: 回放结束时间
```

### 4. 应用场景分析

#### 4.1 主要应用领域

**1. 车载监控系统**
- 公交车、出租车、货运车辆实时监控
- 驾驶员行为监控和安全管理
- 车辆轨迹回放和历史查询

**2. 运输管理**
- 危险品运输车辆监控
- 客运车辆安全管理
- 物流运输过程监控

**3. 应急指挥**
- 交通事故现场视频回传
- 紧急情况实时监控
- 指挥中心远程调度

#### 4.2 技术特点

**1. 实时性要求**
- 支持实时音视频传输
- 低延迟数据传输
- 支持多种码流类型

**2. 可靠性保障**
- TCP/UDP双协议支持
- 会话管理和超时控制
- 错误处理和重传机制

**3. 扩展性设计**
- 模块化架构
- 可配置的端口和参数
- 支持多种设备接入

### 5. 配置和启用

#### 5.1 配置文件
```yaml
jt1078:
  enable: true          # 是否启用JT1078服务
  port: 21078          # 设备接入端口
  password: admin123   # 设备鉴权密码
```

#### 5.2 启用条件
- 通过`@ConditionalOnProperty(value = "jt1078.enable", havingValue = "true")`控制
- 默认端口21078
- 支持设备密码鉴权

#### 5.3 API接口示例
```bash
# 开启实时视频流
curl http://localhost:18080/api/jt1078/start/live/18864197066/1
```

### 6. 模块评估

#### 6.1 功能完整性
- ✅ 协议实现相对完整
- ✅ 支持核心音视频功能
- ⚠️ 发现2个TODO注释：
  1. JT1078ServerApplication.java:89 - TODO: 实现设备状态监控
  2. JT1078MessageHandler.java:156 - TODO: 添加音频编码格式处理
- ⚠️ 核心功能相对稳定，待完善功能不影响主要业务流程

#### 6.2 业务依赖
- ⚠️ 与主程序有依赖关系（VManageBootstrap中引用）
- ⚠️ 可能被特定业务场景使用
